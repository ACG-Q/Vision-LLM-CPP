name: ğŸ› ï¸ Multi-Platform Builder

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'ç¼–è¯‘æ¨¡å¼'
        required: true
        default: 'Release'
        type: choice
        options: [Release, Debug]
      paddle_version:
        description: 'Paddle é¢„æµ‹åº“ç‰ˆæœ¬'
        default: '2.5.0'

jobs:
  # --- Android ç¼–è¯‘ä»»åŠ¡ ---
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ› ï¸ Setup NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r21e
          add-to-path: true

      - name: ğŸ“¦ Build Android (arm64-v8a)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          chmod +x ./scripts/build_android.sh
          ./scripts/build_android.sh ${{ github.event.inputs.build_type }}

      - name: ğŸ“¦ Collect Android Artifacts
        run: |
          mkdir -p output_android
          cp build_android/libocr_engine.so output_android/
          cp inference_lite_lib/cxx/lib/libpaddle_light_api_shared.so output_android/

          if [ -d "OpenCV-android-sdk" ]; then
              cp OpenCV-android-sdk/sdk/native/libs/arm64-v8a/*.so output_android/
          fi

          cp core/ocr_engine.h output_android/


      - name: ğŸ“¤ Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ocr-android-lib
          path: output_android/*

  # --- Windows ç¼–è¯‘ä»»åŠ¡ ---
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ› ï¸ Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: ğŸ“¦ Build Windows (x64)
        shell: powershell
        run: |
          ./scripts/build_windows.ps1 -BuildType ${{ github.event.inputs.build_type }}

      - name: ğŸ“¦ Collect Windows Artifacts
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path output_win
          
          # 1. å¤åˆ¶ OCR Engine
          Write-Host "Collecting ocr_engine.dll..."
          if (Test-Path "build_win\Release\ocr_engine.dll") {
              Copy-Item "build_win\Release\ocr_engine.dll" output_win\
          } elseif (Test-Path "build_win\Debug\ocr_engine.dll") {
              Copy-Item "build_win\Debug\ocr_engine.dll" output_win\
          }
          
          # Copy header file for ocr_engine
          Copy-Item "core\ocr_engine.h" output_win\

          # 2. æœç´¢å¹¶å¤åˆ¶ Paddle ç›¸å…³ DLL (åŒ…æ‹¬ paddle_inference.dll å’Œ MKL ä¾èµ–)
          Write-Host "Collecting Paddle dependencies..."
          Get-ChildItem -Path paddle_inference -Filter *.dll -Recurse | ForEach-Object {
              Write-Host "Found: $($_.FullName)"
              Copy-Item $_.FullName output_win\
          }

          # 3. æœç´¢å¹¶å¤åˆ¶ OpenCV è¿è¡Œåº“ (é€šå¸¸åœ¨ bin ç›®å½•ä¸‹)
          Write-Host "Collecting OpenCV dependencies..."
          Get-ChildItem -Path opencv\build -Filter *.dll -Recurse | Where-Object { $_.FullName -like "*\bin\*" } | ForEach-Object {
              Write-Host "Found: $($_.FullName)"
              Copy-Item $_.FullName output_win\
          }

          # 4. åˆ—å‡ºæœ€ç»ˆæ”¶é›†çš„æ–‡ä»¶
          Write-Host "Total files collected in output_win:"
          Get-ChildItem output_win | Select-Object Name

      - name: ğŸ“¤ Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ocr-windows-dll
          path: output_win/*
