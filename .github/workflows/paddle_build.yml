name: ğŸ› ï¸ Multi-Platform Builder

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'ç¼–è¯‘æ¨¡å¼'
        required: true
        default: 'Release'
        type: choice
        options: [Release, Debug]
      paddle_version:
        description: 'Paddle é¢„æµ‹åº“ç‰ˆæœ¬'
        default: '2.5.0'

jobs:
  # --- Android ç¼–è¯‘ä»»åŠ¡ ---
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ› ï¸ Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: ğŸ“¦ Build Android (arm64-v8a)
        run: |
          chmod +x ./scripts/build_android.sh
          ./scripts/build_android.sh ${{ github.event.inputs.build_type }}

      - name: ğŸ“¦ Collect Android Artifacts
        run: |
          mkdir -p output_android
          cp build_android/libocr_lib.so output_android/
          cp inference_lite_lib/cxx/lib/libpaddle_light_api_shared.so output_android/

      - name: ğŸ“¤ Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ocr-android-lib
          path: output_android/*

  # --- Windows ç¼–è¯‘ä»»åŠ¡ ---
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ› ï¸ Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: ğŸ“¦ Build Windows (x64)
        shell: powershell
        run: |
          ./scripts/build_windows.ps1 -BuildType ${{ github.event.inputs.build_type }}

      - name: ğŸ“¦ Collect Windows Artifacts
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path output_win
          Copy-Item build_win\Release\ocr_lib.dll output_win\
          Copy-Item paddle_inference\paddle\lib\paddle_inference.dll output_win\
          Copy-Item opencv\build\x64\vc16\bin\opencv_world*.dll output_win\
          # MKL and other dependencies are often in paddle_inference\third_party\install\mklml\lib\
          if (Test-Path "paddle_inference\third_party\install\mklml\lib\*.dll") {
              Copy-Item paddle_inference\third_party\install\mklml\lib\*.dll output_win\
          }

      - name: ğŸ“¤ Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ocr-windows-dll
          path: output_win/*
